// Backend Node.js pour l'API Enedis - Optimis√© pour Render.com
// D√©ploiement : https://render.com

const express = require('express');
const cors = require('cors');
const fetch = require('node-fetch');

const app = express();
const PORT = process.env.PORT || 3001; // Render utilise une variable d'environnement PORT

// Configuration CORS pour autoriser les requ√™tes depuis n'importe quel domaine
app.use(cors({
    origin: '*',
    methods: ['GET', 'POST', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization']
}));

// Middleware pour parser le JSON
app.use(express.json());

// Route de sant√© pour Render (health check)
app.get('/health', (req, res) => {
    res.status(200).json({ 
        status: 'ok', 
        service: 'Enedis API Backend',
        timestamp: new Date().toISOString()
    });
});

// Route principale
app.get('/', (req, res) => {
    res.send(`
        <html>
        <head>
            <title>‚ö° API Enedis Backend - Render</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    padding: 40px; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                }
                .container { 
                    max-width: 800px; 
                    margin: 0 auto; 
                    background: white; 
                    padding: 30px; 
                    border-radius: 15px;
                    color: #333;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                }
                h1 { color: #667eea; text-align: center; }
                .status { 
                    background: #e8f5e9; 
                    color: #2e7d32; 
                    padding: 15px; 
                    border-radius: 8px; 
                    margin: 20px 0;
                    text-align: center;
                    font-weight: 600;
                }
                .endpoint { 
                    background: #e3f2fd; 
                    padding: 15px; 
                    border-radius: 8px; 
                    margin: 20px 0; 
                }
                code { 
                    background: #f5f5f5; 
                    padding: 5px 10px; 
                    border-radius: 3px;
                    font-family: monospace;
                }
                .test-btn { 
                    background: #667eea; 
                    color: white; 
                    padding: 12px 24px; 
                    border: none; 
                    border-radius: 8px; 
                    cursor: pointer; 
                    margin: 10px 5px;
                    font-size: 1em;
                    font-weight: 600;
                    transition: transform 0.2s;
                }
                .test-btn:hover { 
                    background: #5568d3;
                    transform: translateY(-2px);
                }
                pre { 
                    background: #f5f5f5; 
                    padding: 15px; 
                    border-radius: 8px; 
                    overflow-x: auto;
                    font-size: 0.9em;
                }
                .info { color: #666; font-size: 0.9em; margin-top: 10px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>‚ö° Backend API Enedis</h1>
                <div class="status">
                    ‚úÖ Serveur actif et op√©rationnel
                </div>
                
                <h3>üìç Endpoint disponible :</h3>
                <div class="endpoint">
                    <strong>GET</strong> <code>/api/enedis/:postalCode</code>
                    <p class="info">R√©cup√®re les interruptions √©lectriques en cours pour un code postal</p>
                </div>
                
                <h3>üß™ Tests rapides :</h3>
                <button class="test-btn" onclick="test('29460')">‚ö†Ô∏è Test 29460 (avec panne)</button>
                <button class="test-btn" onclick="test('75001')">‚úÖ Test 75001 (sans panne)</button>
                
                <h3>üìã R√©sultat :</h3>
                <pre id="result">Cliquez sur un bouton de test...</pre>
                
                <h3>üí° Utilisation depuis votre application :</h3>
                <div class="endpoint">
                    <code>https://votre-app.onrender.com/api/enedis/29460</code>
                    <p class="info">Remplacez "votre-app" par le nom de votre service Render</p>
                </div>
                
                <script>
                    async function test(postalCode) {
                        document.getElementById('result').textContent = '‚è≥ Chargement...';
                        try {
                            const response = await fetch('/api/enedis/' + postalCode);
                            const data = await response.json();
                            document.getElementById('result').textContent = JSON.stringify(data, null, 2);
                        } catch (error) {
                            document.getElementById('result').textContent = '‚ùå Erreur: ' + error.message;
                        }
                    }
                </script>
            </div>
        </body>
        </html>
    `);
});

// Route pour r√©cup√©rer les interruptions par code postal
app.get('/api/enedis/:postalCode', async (req, res) => {
    try {
        const postalCode = req.params.postalCode;
        
        console.log(`üì° [${new Date().toISOString()}] Requ√™te pour le code postal: ${postalCode}`);
        
        // Validation du code postal
        if (!/^\d{5}$/.test(postalCode)) {
            console.log(`‚ùå Code postal invalide: ${postalCode}`);
            return res.status(400).json({
                status: 'error',
                error: 'Code postal invalide',
                message: 'Le code postal doit contenir 5 chiffres'
            });
        }
        
        // URL de l'API Enedis avec filtre statut="En cours"
        const apiUrl = `https://data.enedis.fr/api/explore/v2.1/catalog/datasets/interruptions-de-courant/records?where=code_postal="${postalCode}" AND statut="En cours"&limit=20&order_by=date_et_heure_de_debut DESC`;
        
        console.log('üîç Appel API Enedis...');
        
        const response = await fetch(apiUrl, {
            headers: {
                'Accept': 'application/json',
                'User-Agent': 'Enedis-Monitor/1.0'
            },
            timeout: 10000 // Timeout de 10 secondes
        });
        
        if (!response.ok) {
            throw new Error(`Erreur API Enedis: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        console.log(`‚úÖ ${data.results ? data.results.length : 0} interruption(s) trouv√©e(s)`);
        
        // Transformer les donn√©es pour l'application
        const interruptions = data.results || [];
        
        if (interruptions.length === 0) {
            return res.json({
                status: 'ok',
                message: 'Aucune interruption en cours',
                interruptions: [],
                codePostal: postalCode,
                timestamp: new Date().toISOString()
            });
        }
        
        // Formater les interruptions
        const formattedInterruptions = interruptions.map(item => ({
            commune: item.commune,
            statut: item.statut,
            type: item.type_intervention,
            clientsTouches: item.nombre_clients_touches,
            dateDebut: item.date_et_heure_de_debut,
            dateFinPrevue: item.date_et_heure_de_fin_prevue,
            motif: item.motif_intervention,
            codePostal: item.code_postal
        }));
        
        console.log(`üìä R√©ponse envoy√©e avec ${formattedInterruptions.length} interruption(s)`);
        
        res.json({
            status: 'outage',
            message: `${interruptions.length} interruption(s) en cours`,
            interruptions: formattedInterruptions,
            codePostal: postalCode,
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error('‚ùå Erreur:', error.message);
        res.status(500).json({
            status: 'error',
            message: 'Erreur lors de la r√©cup√©ration des donn√©es',
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
});

// Middleware pour g√©rer les routes non trouv√©es
app.use((req, res) => {
    res.status(404).json({
        status: 'error',
        message: 'Route non trouv√©e',
        availableRoutes: [
            'GET /',
            'GET /health',
            'GET /api/enedis/:postalCode'
        ]
    });
});

// D√©marrage du serveur
app.listen(PORT, '0.0.0.0', () => {
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë                                                       ‚ïë');
    console.log('‚ïë     ‚ö° Backend API Enedis - D√©marr√© sur Render  ‚ö°    ‚ïë');
    console.log('‚ïë                                                       ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');
    console.log(`‚úÖ Serveur actif sur le port : ${PORT}`);
    console.log(`üåê Environnement : ${process.env.NODE_ENV || 'development'}`);
    console.log(`üì° API disponible : /api/enedis/:postalCode`);
    console.log(`üíö Health check : /health\n`);
});

// Gestion gracieuse de l'arr√™t
process.on('SIGTERM', () => {
    console.log('üõë Signal SIGTERM re√ßu, arr√™t gracieux...');
    process.exit(0);
});

process.on('SIGINT', () => {
    console.log('\nüõë Signal SIGINT re√ßu, arr√™t gracieux...');
    process.exit(0);
});
